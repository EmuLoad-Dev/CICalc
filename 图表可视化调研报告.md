# 图表可视化功能调研报告

## 调研目标
调研是否能用微信小程序原生功能实现图表可视化，不依赖第三方库（如 ECharts）。

## 调研结论

### ✅ **可以使用微信原生功能实现**

微信小程序提供了完整的 **Canvas API**，可以完全使用原生功能实现图表可视化，无需依赖第三方库。

---

## 技术方案

### 1. 微信小程序 Canvas API 能力

微信小程序提供了两种 Canvas 渲染方式：

#### 方式一：Canvas 2D（推荐）
- **API**: `wx.createCanvasContext()` 或 `<canvas type="2d">`
- **特点**: 
  - 性能更好，支持硬件加速
  - API 更现代，与 Web Canvas API 2D 标准一致
  - 支持离屏渲染
- **适用场景**: 复杂图表、动画效果

#### 方式二：Canvas 旧版 API
- **API**: `<canvas canvas-id="xxx">` + `wx.createCanvasContext()`
- **特点**: 
  - 兼容性好，支持所有微信版本
  - API 相对简单
- **适用场景**: 简单图表

### 2. Canvas API 支持的绘图能力

微信小程序 Canvas API 支持以下绘图操作：

#### 基础图形绘制
- ✅ **线条**: `ctx.moveTo()`, `ctx.lineTo()`, `ctx.stroke()`
- ✅ **矩形**: `ctx.rect()`, `ctx.fillRect()`, `ctx.strokeRect()`
- ✅ **圆形/弧形**: `ctx.arc()`, `ctx.arcTo()`
- ✅ **路径**: `ctx.beginPath()`, `ctx.closePath()`

#### 样式设置
- ✅ **颜色**: `ctx.setFillStyle()`, `ctx.setStrokeStyle()`
- ✅ **线宽**: `ctx.setLineWidth()`
- ✅ **线型**: `ctx.setLineCap()`, `ctx.setLineJoin()`, `ctx.setLineDash()`
- ✅ **字体**: `ctx.setFontSize()`, `ctx.setTextAlign()`, `ctx.setTextBaseline()`

#### 文本绘制
- ✅ **文本**: `ctx.fillText()`, `ctx.strokeText()`
- ✅ **文本测量**: `ctx.measureText()` (Canvas 2D)

#### 变换操作
- ✅ **平移**: `ctx.translate()`
- ✅ **旋转**: `ctx.rotate()`
- ✅ **缩放**: `ctx.scale()`
- ✅ **变换矩阵**: `ctx.transform()`, `ctx.setTransform()`

#### 其他功能
- ✅ **图像绘制**: `ctx.drawImage()`
- ✅ **渐变**: `ctx.createLinearGradient()`, `ctx.createCircularGradient()`
- ✅ **阴影**: `ctx.setShadow()`
- ✅ **裁剪**: `ctx.clip()`
- ✅ **保存/恢复**: `ctx.save()`, `ctx.restore()`

### 3. 实现图表所需的核心功能

基于项目需求（资产增长曲线图），需要实现：

#### 折线图绘制
- ✅ 使用 `lineTo()` 连接数据点
- ✅ 使用 `arc()` 绘制数据点标记
- ✅ 使用 `fillText()` 绘制数据标签

#### 坐标轴绘制
- ✅ 使用 `lineTo()` 绘制 X/Y 轴
- ✅ 使用 `fillText()` 绘制刻度标签
- ✅ 使用 `setLineDash()` 绘制网格线

#### 图例和标题
- ✅ 使用 `fillText()` 绘制标题
- ✅ 使用 `fillRect()` + `fillText()` 绘制图例

#### 交互功能（可选）
- ✅ 监听 `touchstart`, `touchmove`, `touchend` 实现缩放、拖拽
- ✅ 使用 `measureText()` 计算文本宽度，实现自适应布局

---

## 实现方案对比

### 方案一：使用原生 Canvas API（推荐）

#### 优点
- ✅ **零依赖**: 不增加包体积，符合小程序包大小限制
- ✅ **完全可控**: 可以精确控制每个细节
- ✅ **性能好**: 原生 API，性能优化到位
- ✅ **兼容性好**: 支持所有微信版本
- ✅ **符合要求**: 不依赖第三方库

#### 缺点
- ⚠️ **开发工作量大**: 需要手动实现所有绘图逻辑
- ⚠️ **代码复杂度高**: 需要处理坐标计算、数据映射等
- ⚠️ **维护成本**: 后续修改需要手动调整代码

#### 开发工作量估算
- **简单折线图**: 2-3 天
- **带坐标轴、网格、图例的完整图表**: 5-7 天
- **带交互功能（缩放、拖拽）**: 10-14 天

### 方案二：使用 ECharts（不推荐，不符合要求）

#### 优点
- ✅ 功能丰富，开箱即用
- ✅ 开发效率高
- ✅ 交互功能完善

#### 缺点
- ❌ **不符合要求**: 依赖第三方库
- ❌ **包体积大**: echarts.min.js 约 1MB，增加包体积
- ❌ **可能超限**: 小程序包大小限制 2MB，1MB 的库占用较大

---

## 具体实现建议

### 1. 技术选型

**推荐使用 Canvas 2D API** (`<canvas type="2d">`)

原因：
- 性能更好，支持硬件加速
- API 更现代，与标准一致
- 支持离屏渲染，适合复杂场景

### 2. 实现步骤

#### 第一步：基础折线图
1. 创建 Canvas 组件
2. 实现数据映射（将数值映射到画布坐标）
3. 绘制坐标轴
4. 绘制折线和数据点

#### 第二步：完善图表
1. 添加网格线
2. 添加刻度标签
3. 添加图例
4. 添加标题

#### 第三步：优化体验
1. 响应式布局（适配不同屏幕）
2. 数据标签显示
3. 动画效果（可选）

#### 第四步：交互功能（可选）
1. 触摸事件处理
2. 缩放功能
3. 拖拽功能

### 3. 代码结构建议

```
miniprogram/
  components/
    chart/
      index.js      # 图表组件逻辑
      index.wxml    # Canvas 组件
      index.wxss    # 样式
      index.json    # 组件配置
  utils/
    chart.js        # 图表绘制工具函数
      - drawAxis()      # 绘制坐标轴
      - drawGrid()      # 绘制网格
      - drawLine()      # 绘制折线
      - drawPoints()    # 绘制数据点
      - drawLabels()    # 绘制标签
      - drawLegend()    # 绘制图例
```

### 4. 核心实现要点

#### 数据映射
```javascript
// 将数据值映射到画布坐标
function mapValueToCanvas(value, min, max, canvasSize, padding) {
  const range = max - min;
  const ratio = (value - min) / range;
  return padding + ratio * (canvasSize - 2 * padding);
}
```

#### 坐标轴绘制
```javascript
// 绘制 X 轴
ctx.beginPath();
ctx.moveTo(padding, canvasHeight - padding);
ctx.lineTo(canvasWidth - padding, canvasHeight - padding);
ctx.stroke();

// 绘制 Y 轴
ctx.beginPath();
ctx.moveTo(padding, padding);
ctx.lineTo(padding, canvasHeight - padding);
ctx.stroke();
```

#### 折线绘制
```javascript
// 绘制折线
ctx.beginPath();
dataPoints.forEach((point, index) => {
  if (index === 0) {
    ctx.moveTo(point.x, point.y);
  } else {
    ctx.lineTo(point.x, point.y);
  }
});
ctx.stroke();
```

---

## 性能考虑

### Canvas 性能优化建议

1. **避免频繁重绘**
   - 只在数据变化时重绘
   - 使用 `requestAnimationFrame` 优化动画

2. **合理设置 Canvas 尺寸**
   - 使用 `devicePixelRatio` 适配高分辨率屏幕
   - 避免过大的 Canvas（建议不超过 1000x1000）

3. **减少绘制操作**
   - 合并相同样式的绘制操作
   - 使用 `save()` 和 `restore()` 减少样式设置

4. **离屏渲染**（Canvas 2D）
   - 对于复杂图表，可以使用离屏 Canvas 预渲染

---

## 兼容性说明

### Canvas 2D 兼容性
- ✅ 微信 7.0.0+ 支持
- ✅ 基础库 2.9.0+ 支持
- ⚠️ 低版本需要降级到旧版 Canvas API

### 降级方案
如果需要在低版本微信中运行，可以：
1. 检测基础库版本
2. 低版本使用旧版 Canvas API
3. 高版本使用 Canvas 2D API

---

## 参考资源

### 官方文档
- [微信小程序 Canvas 组件](https://developers.weixin.qq.com/miniprogram/dev/component/canvas.html)
- [Canvas 2D API](https://developers.weixin.qq.com/miniprogram/dev/api/canvas/Canvas.html)

### 示例代码
- 微信小程序官方示例中有 Canvas 绘制示例
- 可以参考 Web Canvas API 文档（API 基本一致）

---

## 总结

### ✅ **结论：可以使用微信原生功能实现图表可视化**

**推荐方案**：
- 使用 **Canvas 2D API** 实现图表绘制
- 手动实现折线图、坐标轴、图例等组件
- 根据项目需求逐步完善功能

**开发建议**：
1. 先实现基础折线图功能
2. 逐步添加坐标轴、网格、图例等
3. 最后考虑交互功能（如需要）

**优势**：
- ✅ 零依赖，不增加包体积
- ✅ 完全可控，可定制化
- ✅ 性能好，兼容性强
- ✅ 符合项目要求（不依赖第三方库）

**注意事项**：
- ⚠️ 开发工作量相对较大
- ⚠️ 需要处理坐标计算、数据映射等细节
- ⚠️ 建议封装成可复用组件，便于维护

---

## 下一步行动

1. **创建图表组件**
   - 在 `miniprogram/components/` 下创建 `chart` 组件
   - 实现基础折线图绘制功能

2. **集成到计算页面**
   - 在 `pages/calc/index.wxml` 中引入图表组件
   - 传递计算数据给图表组件

3. **生成时间序列数据**
   - 在 `utils/calc.js` 中添加 `generateTimeSeriesData()` 函数
   - 生成按时间点的资产、投入、收益数据

4. **测试和优化**
   - 在不同设备上测试显示效果
   - 优化性能和用户体验

---

**调研完成时间**: 2024-12-XX  
**调研人**: AI Assistant

